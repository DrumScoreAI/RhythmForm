name: Check for New Datasets and Update README

on:
  # Run automatically every day at 3:00 AM UTC
  # schedule:
  #   - cron: '0 3 * * *'
  # Allow manual triggering from the GitHub Actions tab
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    # Grant permissions for the workflow to write back to the repository
    permissions:
      contents: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          # The region is required by the action, but not used by your specific endpoint
          aws-region: us-east-1

      - name: Check for latest dataset and update README
        env:
          S3_ENDPOINT_URL: https://s3.eidf.ac.uk
          S3_BUCKET_NAME: rhythmformdatasets
        run: |
          set -e
          echo "Checking for latest datasets in s3://${S3_BUCKET_NAME}..."

          # --- 1. Find the latest .zip and .tar.gz files on S3 ---
          # The timestamp in the name means we can just find the alphabetically last file.
          LATEST_ZIP=$(aws s3 ls ${S3_ENDPOINT_URL}/${S3_BUCKET_NAME}/ | grep '\.zip$' | sort | tail -n 1 | awk '{print $4}' || echo "")
          LATEST_TAR=$(aws s3 ls ${S3_ENDPOINT_URL}/${S3_BUCKET_NAME}/ | grep '\.tar.gz$' | sort | tail -n 1 | awk '{print $4}' || echo "")

          if [ -z "$LATEST_ZIP" ] || [ -z "$LATEST_TAR" ]; then
            echo "Could not find both a .zip or .tar.gz file in the bucket. Exiting."
            exit 0
          fi

          echo "Latest .zip on S3: $LATEST_ZIP"
          echo "Latest .tar.gz on S3: $LATEST_TAR"

          # --- 2. Get the current dataset names from the README ---
          CURRENT_ZIP=$(grep -o 'training_data_[0-9_]*.zip' README.md | head -n 1)
          CURRENT_TAR=$(grep -o 'training_data_[0-9_]*.tar.gz' README.md | head -n 1)

          echo "Current .zip in README: $CURRENT_ZIP"
          echo "Current .tar.gz in README: $CURRENT_TAR"

          # --- 3. Compare and update if the S3 version is newer ---
          if [ "$LATEST_ZIP" != "$CURRENT_ZIP" ]; then
            echo "Newer dataset found. Updating README.md..."

            # Use sed to replace the old filenames with the new ones in the README
            sed -i "s|${CURRENT_ZIP}|${LATEST_ZIP}|g" README.md
            sed -i "s|${CURRENT_TAR}|${LATEST_TAR}|g" README.md

            echo "README.md updated."

            # --- 4. Commit and push the changes ---
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add README.md
            git commit -m "Docs: Update latest dataset links in README"
            git push
            echo "Changes pushed to repository."
          else
            echo "README.md is already up to date. No changes needed."
          fi
        
        
